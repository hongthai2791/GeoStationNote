<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoStation Note</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS (Bản đồ miễn phí) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google GenAI SDK (Import Map) -->
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@^1.38.0"
      }
    }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .leaflet-container { width: 100%; height: 100%; z-index: 10; }
        /* Ẩn thanh cuộn nhưng vẫn cuộn được */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 overflow-hidden h-screen w-screen flex relative">

    <!-- SIDEBAR -->
    <div id="sidebar" class="bg-white shadow-xl h-full flex flex-col transition-all duration-300 z-20 absolute md:relative w-full md:w-96 transform -translate-x-full md:translate-x-0">
        <!-- Sidebar Content Injected Here -->
        <div id="sidebar-content" class="flex-1 overflow-hidden flex flex-col"></div>
    </div>

    <!-- MAP AREA -->
    <div class="flex-1 relative h-full">
        <div id="map" class="w-full h-full bg-gray-200"></div>

        <!-- Floating Buttons -->
        <div class="absolute top-4 right-4 flex flex-col gap-2 z-[400]">
            <button onclick="app.setSidebarView('SETTINGS')" class="bg-white p-3 rounded-full shadow-lg hover:bg-gray-100 text-gray-700 transition" title="Cài đặt">
                <i data-lucide="settings" class="w-6 h-6"></i>
            </button>
            <button onclick="app.locateMe()" class="bg-blue-600 p-3 rounded-full shadow-lg hover:bg-blue-700 text-white transition" title="Vị trí của tôi">
                <i data-lucide="locate" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Sidebar Toggle (Mobile) -->
        <button id="mobile-menu-btn" onclick="app.toggleSidebar()" class="absolute top-4 left-4 bg-white p-2 rounded-md shadow-lg z-[400] md:hidden">
            <i data-lucide="list" class="w-6 h-6"></i>
        </button>
    </div>

    <!-- MAIN APP SCRIPT -->
    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        // --- STATE MANAGEMENT ---
        const STORE_KEY_DATA = 'geo_station_data_v1';
        const STORE_KEY_CONFIG = 'geo_station_config_v1';

        class App {
            constructor() {
                this.stations = JSON.parse(localStorage.getItem(STORE_KEY_DATA) || '[]');
                // Load config or default empty object
                this.config = JSON.parse(localStorage.getItem(STORE_KEY_CONFIG) || '{}');
                
                // Ensure default structure
                this.config = {
                    googleMapsApiKey: this.config.googleMapsApiKey || "",
                    googleSheetScriptUrl: this.config.googleSheetScriptUrl || "",
                    geminiApiKey: this.config.geminiApiKey || "",
                    customApiUrl: this.config.customApiUrl || "" // New field for Custom API
                };
                
                this.view = 'LIST'; // LIST, FORM, SETTINGS
                this.selectedLocation = null;
                this.isSidebarOpen = window.innerWidth >= 768;
                
                // Map References
                this.map = null;
                this.markers = [];
                this.tempMarker = null;
                
                this.init();
            }

            init() {
                this.initMap();
                this.renderSidebar();
                this.updateSidebarVisibility();
                lucide.createIcons();
            }

            // --- MAP LOGIC (Leaflet Default) ---
            initMap() {
                // Default Ho Chi Minh City (HCM)
                const startLat = 10.7769;
                const startLng = 106.7009;

                this.map = L.map('map', { zoomControl: false }).setView([startLat, startLng], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(this.map);
                L.control.zoom({ position: 'bottomright' }).addTo(this.map);

                // Click Event
                this.map.on('click', (e) => {
                    this.handleMapClick({ lat: e.latlng.lat, lng: e.latlng.lng });
                });

                this.renderMapMarkers();
            }

            renderMapMarkers() {
                // Clear existing
                this.markers.forEach(m => this.map.removeLayer(m));
                this.markers = [];

                // Add Stations
                this.stations.forEach(station => {
                    const marker = L.circleMarker([station.location.lat, station.location.lng], {
                        color: 'white',
                        fillColor: '#2563EB', // blue-600
                        fillOpacity: 1,
                        radius: 8,
                        weight: 2
                    }).addTo(this.map);
                    
                    marker.bindTooltip(station.name);
                    marker.on('click', (e) => {
                        L.DomEvent.stopPropagation(e);
                        this.handleMarkerClick(station);
                    });
                    this.markers.push(marker);
                });
            }

            updateTempMarker() {
                if (this.tempMarker) {
                    this.map.removeLayer(this.tempMarker);
                    this.tempMarker = null;
                }

                if (this.selectedLocation) {
                    // Simple Red Icon
                    const redIcon = L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });

                    this.tempMarker = L.marker([this.selectedLocation.lat, this.selectedLocation.lng], { icon: redIcon }).addTo(this.map);
                }
            }

            locateMe() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        this.map.setView([loc.lat, loc.lng], 16);
                        this.handleMapClick(loc);
                    }, () => alert("Không thể lấy vị trí của bạn."));
                }
            }

            // --- ACTIONS ---
            handleMapClick(loc) {
                this.selectedLocation = loc;
                this.updateTempMarker();
                this.setSidebarView('FORM');
                if (!this.isSidebarOpen) this.toggleSidebar();
            }

            handleMarkerClick(station) {
                this.map.setView([station.location.lat, station.location.lng], 16);
                this.setSidebarView('LIST');
                if (!this.isSidebarOpen) this.toggleSidebar();
            }

            async saveStation(data) {
                // 1. Save Local
                this.stations.unshift(data);
                this.saveData();
                
                // 2. UI Update
                this.selectedLocation = null;
                this.updateTempMarker();
                this.renderMapMarkers();
                this.setSidebarView('LIST');
                
                // 3. Sync to Google Sheet (if configured)
                if (this.config.googleSheetScriptUrl) {
                    this.syncToSheet(data);
                }

                // 4. Sync to Custom API (AJAX)
                if (this.config.customApiUrl) {
                    await this.syncToApi(data);
                }
            }

            deleteStation(id) {
                if(confirm('Bạn có chắc muốn xóa trạm này?')) {
                    this.stations = this.stations.filter(s => s.id !== id);
                    this.saveData();
                    this.renderMapMarkers();
                    this.renderSidebar();
                }
            }

            saveData() {
                localStorage.setItem(STORE_KEY_DATA, JSON.stringify(this.stations));
            }

            saveConfig(newConfig) {
                this.config = newConfig;
                localStorage.setItem(STORE_KEY_CONFIG, JSON.stringify(this.config));
                this.setSidebarView('LIST');
                alert("Đã lưu cài đặt!");
            }

            // --- UI RENDERING ---
            toggleSidebar() {
                this.isSidebarOpen = !this.isSidebarOpen;
                this.updateSidebarVisibility();
            }

            updateSidebarVisibility() {
                const el = document.getElementById('sidebar');
                const btn = document.getElementById('mobile-menu-btn');
                if (this.isSidebarOpen) {
                    el.classList.remove('-translate-x-full');
                    if(btn) btn.classList.add('hidden');
                } else {
                    el.classList.add('-translate-x-full');
                    if(btn) btn.classList.remove('hidden');
                }
            }

            setSidebarView(viewName) {
                this.view = viewName;
                if (viewName === 'LIST') this.selectedLocation = null;
                this.updateTempMarker();
                this.renderSidebar();
            }

            renderSidebar() {
                const container = document.getElementById('sidebar-content');
                container.innerHTML = '';

                if (this.view === 'LIST') {
                    container.innerHTML = this.getListViewHTML();
                } else if (this.view === 'FORM') {
                    this.renderFormView(container);
                } else if (this.view === 'SETTINGS') {
                    this.renderSettingsView(container);
                }
                
                lucide.createIcons();
            }

            // HTML Generator: LIST
            getListViewHTML() {
                const listItems = this.stations.length === 0 
                    ? `<div class="text-center text-gray-400 mt-10 p-4">
                        <i data-lucide="map-pin" class="w-10 h-10 mx-auto opacity-50 mb-2"></i>
                        <p>Chưa có dữ liệu.</p>
                        <p class="text-sm">Bấm vào bản đồ để thêm trạm mới.</p>
                       </div>`
                    : this.stations.map(s => `
                        <div class="border rounded-lg p-3 hover:shadow-md transition bg-white mb-3 group relative cursor-pointer" onclick="app.handleMarkerClick(${JSON.stringify(s).replace(/"/g, '&quot;')})">
                             <div class="flex justify-between items-start">
                                <div>
                                  <h3 class="font-semibold text-gray-900">${s.name}</h3>
                                  <p class="text-xs text-gray-500 mb-2">${s.address}</p>
                                </div>
                                <button onclick="event.stopPropagation(); app.deleteStation('${s.id}')" class="text-red-400 hover:text-red-600 p-1">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                             </div>
                             ${s.images.length ? `<div class="flex gap-2 mb-2 overflow-x-auto pb-2 scrollbar-hide">
                                ${s.images.map(img => `<img src="${img}" class="w-16 h-16 object-cover rounded flex-shrink-0" />`).join('')}
                             </div>` : ''}
                             <p class="text-sm text-gray-600 line-clamp-2 bg-gray-50 p-2 rounded">${s.description || 'Không có mô tả'}</p>
                        </div>
                    `).join('');

                return `
                    <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                        <h1 class="font-bold text-lg text-gray-800">Danh sách trạm (${this.stations.length})</h1>
                        <button onclick="app.exportCSV()" class="text-blue-600 hover:bg-blue-50 p-2 rounded" title="Xuất Excel/CSV">
                            <i data-lucide="download" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 bg-gray-100">
                        ${listItems}
                    </div>
                `;
            }

            // HTML Generator: FORM
            renderFormView(container) {
                // Template
                container.innerHTML = `
                    <div class="p-4 border-b flex justify-between items-center bg-blue-600 text-white">
                        <h2 class="font-semibold text-lg flex items-center gap-2">
                            <i data-lucide="map-pin" class="w-5 h-5"></i> Thêm Trạm Mới
                        </h2>
                        <button onclick="app.setSidebarView('LIST')" class="hover:bg-blue-700 p-1 rounded">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <form id="station-form" class="p-5 space-y-4 flex-1 overflow-y-auto">
                        <div class="bg-gray-50 p-2 rounded text-xs text-gray-600 flex justify-between">
                            <span>Lat: ${this.selectedLocation.lat.toFixed(5)}</span>
                            <span>Lng: ${this.selectedLocation.lng.toFixed(5)}</span>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Tên trạm</label>
                            <input type="text" id="inp-name" required class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ví dụ: Trạm Biến áp A">
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-1">Địa chỉ</label>
                            <input type="text" id="inp-address" required class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Số 1, Đại Cồ Việt...">
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-1">Hình ảnh (Max 4)</label>
                            <div id="img-preview" class="grid grid-cols-4 gap-2 mb-2"></div>
                            <button type="button" onclick="document.getElementById('inp-file').click()" class="border-2 border-dashed w-full p-2 text-gray-400 rounded hover:border-blue-500 text-sm flex items-center justify-center gap-2">
                                <i data-lucide="camera" class="w-4 h-4"></i> Thêm ảnh
                            </button>
                            <input type="file" id="inp-file" accept="image/*" multiple class="hidden">
                        </div>

                        <div>
                            <div class="flex justify-between items-end mb-1">
                                <label class="block text-sm font-medium">Mô tả / Ghi chú</label>
                                <button type="button" id="btn-ai" class="text-xs bg-purple-50 text-purple-700 px-2 py-1 rounded border border-purple-200 flex items-center gap-1">
                                    <i data-lucide="sparkles" class="w-3 h-3"></i> Tự động điền (AI)
                                </button>
                            </div>
                            <textarea id="inp-desc" rows="4" class="w-full border rounded p-2 text-sm" placeholder="Mô tả chi tiết..."></textarea>
                        </div>

                        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded font-medium hover:bg-blue-700 mt-4 flex justify-center gap-2">
                            <i data-lucide="save" class="w-5 h-5"></i> Lưu Trạm
                        </button>
                    </form>
                `;

                // Logic for Form
                const images = [];
                const renderImages = () => {
                    const div = document.getElementById('img-preview');
                    div.innerHTML = images.map((img, i) => `
                        <div class="relative aspect-square rounded overflow-hidden border">
                            <img src="${img}" class="w-full h-full object-cover">
                            <button type="button" onclick="document.getElementById('station-form').removeImage(${i})" class="absolute top-0 right-0 bg-red-500 text-white p-0.5">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </div>
                    `).join('');
                    lucide.createIcons();
                };

                // Add method to form element to be callable globally via onclick trick (simple JS hack for single file)
                document.getElementById('station-form').removeImage = (idx) => {
                    images.splice(idx, 1);
                    renderImages();
                };

                document.getElementById('inp-file').onchange = (e) => {
                    const files = Array.from(e.target.files).slice(0, 4 - images.length);
                    files.forEach(file => {
                        const reader = new FileReader();
                        reader.onload = () => { images.push(reader.result); renderImages(); };
                        reader.readAsDataURL(file);
                    });
                };

                // AI Button
                document.getElementById('btn-ai').onclick = async (e) => {
                    if(!images.length) return alert("Vui lòng tải ảnh lên trước.");
                    const btn = e.currentTarget;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = `<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Đang phân tích...`;
                    lucide.createIcons();
                    
                    try {
                        const desc = await this.callGemini(images, this.selectedLocation);
                        document.getElementById('inp-desc').value = desc;
                    } catch (err) {
                        alert("Lỗi AI: " + err.message);
                    } finally {
                        btn.innerHTML = originalText;
                        lucide.createIcons();
                    }
                };

                // Submit
                document.getElementById('station-form').onsubmit = (e) => {
                    e.preventDefault();
                    const data = {
                        id: crypto.randomUUID(),
                        name: document.getElementById('inp-name').value,
                        address: document.getElementById('inp-address').value,
                        description: document.getElementById('inp-desc').value,
                        location: this.selectedLocation,
                        images: images,
                        timestamp: Date.now()
                    };
                    this.saveStation(data);
                };
            }

            // HTML Generator: SETTINGS
            renderSettingsView(container) {
                container.innerHTML = `
                    <div class="p-6 h-full overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                             <h2 class="text-2xl font-bold">Cài đặt</h2>
                             <button onclick="app.setSidebarView('LIST')" class="text-gray-500 hover:text-gray-800"><i data-lucide="x"></i></button>
                        </div>
                        <form id="settings-form" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium mb-1">Custom API URL (AJAX)</label>
                                <input type="text" id="cfg-api" value="${this.config.customApiUrl || ''}" class="w-full border p-2 rounded" placeholder="https://api.domain.com/save-station">
                                <p class="text-xs text-gray-500 mt-1">Hệ thống sẽ POST dữ liệu dạng JSON về URL này.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Gemini API Key</label>
                                <input type="password" id="cfg-gemini" value="${this.config.geminiApiKey || ''}" class="w-full border p-2 rounded" placeholder="AIzaSy...">
                                <p class="text-xs text-gray-500 mt-1">Cần thiết để dùng tính năng AI tạo mô tả ảnh.</p>
                            </div>
                            
                             <div class="pt-4 border-t">
                                <label class="block text-sm font-medium mb-1 text-gray-500">Tùy chọn khác (Ít dùng)</label>
                                <div class="space-y-3">
                                    <input type="text" id="cfg-script" value="${this.config.googleSheetScriptUrl || ''}" class="w-full border p-2 rounded text-sm" placeholder="Google Apps Script URL (Tùy chọn)">
                                    <input type="password" id="cfg-key" value="${this.config.googleMapsApiKey || ''}" class="w-full border p-2 rounded text-sm" placeholder="Google Maps API Key (Để trống dùng OSM)">
                                </div>
                            </div>

                            <button type="submit" class="w-full bg-black text-white py-2 rounded flex justify-center gap-2">
                                <i data-lucide="save" class="w-4 h-4"></i> Lưu Cài đặt
                            </button>
                        </form>
                    </div>
                `;
                
                document.getElementById('settings-form').onsubmit = (e) => {
                    e.preventDefault();
                    this.saveConfig({
                        customApiUrl: document.getElementById('cfg-api').value,
                        geminiApiKey: document.getElementById('cfg-gemini').value,
                        googleSheetScriptUrl: document.getElementById('cfg-script').value,
                        googleMapsApiKey: document.getElementById('cfg-key').value
                    });
                };
            }

            // --- SERVICES ---
            
            // Hàm AJAX để lưu dữ liệu về API của bạn
            async syncToApi(station) {
                const url = this.config.customApiUrl;
                if (!url) return;

                // Hiển thị thông báo nhỏ (console)
                console.log("Đang gửi dữ liệu về API...", station);
                
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // 'Authorization': 'Bearer ...' // Nếu bạn cần token thì thêm vào đây
                        },
                        body: JSON.stringify(station)
                    });

                    if (!response.ok) {
                        throw new Error(`API trả về lỗi: ${response.status}`);
                    }

                    console.log("Đã lưu thành công vào API riêng!");
                    // Bạn có thể alert hoặc toast thông báo thành công nếu muốn
                } catch (error) {
                    console.error("Lỗi khi gọi API:", error);
                    alert("Không thể lưu vào API: " + error.message);
                }
            }

            async callGemini(base64Images, location) {
                if (!this.config.geminiApiKey) throw new Error("Chưa nhập Gemini API Key trong Cài đặt.");
                
                // Initialize Client (Client-side usage requires key from settings)
                const ai = new GoogleGenAI({ apiKey: this.config.geminiApiKey });
                
                const parts = base64Images.map(img => ({
                    inlineData: {
                        mimeType: "image/jpeg",
                        data: img.split("base64,")[1] || img
                    }
                }));

                parts.push({ 
                    text: `Hãy phân tích hình ảnh trạm/cơ sở hạ tầng tại tọa độ (${location.lat}, ${location.lng}). Mô tả ngắn gọn (dưới 100 từ) về tình trạng, thiết bị nhìn thấy và môi trường xung quanh.` 
                });

                const response = await ai.models.generateContent({
                    model: "gemini-2.5-flash-latest",
                    contents: { parts: parts }
                });

                return response.text();
            }

            async syncToSheet(station) {
                const url = this.config.googleSheetScriptUrl;
                try {
                    const payload = new FormData();
                    payload.append('id', station.id);
                    payload.append('name', station.name);
                    payload.append('address', station.address);
                    payload.append('lat', station.location.lat);
                    payload.append('lng', station.location.lng);
                    payload.append('description', station.description);
                    
                    await fetch(url, { method: 'POST', mode: 'no-cors', body: payload });
                    console.log("Sent to sheet");
                } catch (e) {
                    console.error("Sheet sync failed", e);
                }
            }

            exportCSV() {
                const headers = ['ID,Name,Address,Lat,Lng,Description,Timestamp'];
                const rows = this.stations.map(s => [
                    s.id,
                    `"${s.name.replace(/"/g, '""')}"`,
                    `"${s.address.replace(/"/g, '""')}"`,
                    s.location.lat,
                    s.location.lng,
                    `"${s.description.replace(/"/g, '""')}"`,
                    new Date(s.timestamp).toISOString()
                ].join(','));
                
                const blob = new Blob([headers.concat(rows).join('\n')], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `stations_${Date.now()}.csv`;
                link.click();
            }
        }

        // Initialize Global App Instance
        window.app = new App();
    </script>
</body>
</html>