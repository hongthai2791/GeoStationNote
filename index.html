<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeoStation Note</title>
    
    <!-- PWA Manifest & Meta -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563EB">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/854/854878.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS (Bản đồ miễn phí) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google GenAI SDK (Import Map) -->
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@^1.38.0"
      }
    }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .leaflet-container { width: 100%; height: 100%; z-index: 10; }
        /* Ẩn thanh cuộn nhưng vẫn cuộn được */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Tùy chỉnh bảng chỉ đường cho gọn trên mobile */
        .leaflet-routing-container {
            max-width: 250px !important;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 overflow-hidden h-screen w-screen flex relative">

    <!-- SIDEBAR -->
    <div id="sidebar" class="bg-white shadow-xl h-full flex flex-col transition-all duration-300 z-20 absolute md:relative w-full md:w-96 transform -translate-x-full md:translate-x-0">
        <!-- Sidebar Content Injected Here -->
        <div id="sidebar-content" class="flex-1 overflow-hidden flex flex-col"></div>
    </div>

    <!-- MAP AREA -->
    <div class="flex-1 relative h-full">
        <div id="map" class="w-full h-full bg-gray-200"></div>

        <!-- Search Bar (Mặc định ẩn, có ID để toggle) -->
        <div id="search-container" class="absolute top-4 left-16 right-16 md:left-1/2 md:right-auto md:-translate-x-1/2 md:w-96 z-[400] hidden transition-all duration-300 origin-top">
             <div class="relative shadow-lg rounded-full group">
                <input type="text" id="search-input" 
                       class="w-full pl-10 pr-4 py-3 rounded-full border-none focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-white/95 backdrop-blur transition-colors"
                       placeholder="Tìm địa chỉ, đường phố..."
                       onkeydown="if(event.key === 'Enter') app.searchAddress(this.value)">
                <div class="absolute left-3 top-3 text-gray-500">
                    <i data-lucide="search" class="w-5 h-5"></i>
                </div>
            </div>
        </div>

        <!-- Floating Buttons -->
        <!-- Adjusted top position for mobile (top-24) to clear sidebar header, keep top-4 on desktop -->
        <div class="absolute top-24 md:top-4 right-4 flex flex-col gap-2 z-[400]">
            <button onclick="app.setSidebarView('SETTINGS')" class="bg-white p-3 rounded-full shadow-lg hover:bg-gray-100 text-gray-700 transition" title="Cài đặt">
                <i data-lucide="settings" class="w-6 h-6"></i>
            </button>
            <button id="btn-locate" onclick="app.locateMe()" class="bg-blue-600 p-3 rounded-full shadow-lg hover:bg-blue-700 text-white transition" title="Vị trí của tôi (Thêm trạm)">
                <i data-lucide="locate" class="w-6 h-6"></i>
            </button>
            <!-- Nút Toggle Search mới -->
            <button onclick="app.toggleSearch()" class="bg-white p-3 rounded-full shadow-lg hover:bg-gray-100 text-gray-700 transition" title="Tìm kiếm">
                <i data-lucide="search" class="w-6 h-6"></i>
            </button>
            <button onclick="app.clearRoute()" class="bg-red-500 p-3 rounded-full shadow-lg hover:bg-red-600 text-white transition hidden" id="btn-clear-route" title="Xóa tuyến đường">
                <i data-lucide="x-circle" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Sidebar Toggle (Mobile) -->
        <button id="mobile-menu-btn" onclick="app.toggleSidebar()" class="absolute top-4 left-4 bg-white p-2 rounded-md shadow-lg z-[400] md:hidden">
            <i data-lucide="list" class="w-6 h-6"></i>
        </button>
    </div>

    <!-- MAIN APP SCRIPT -->
    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        // Register PWA Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered:', reg))
                    .catch(err => console.log('SW failed:', err));
            });
        }

        // --- STATE MANAGEMENT ---
        const STORE_KEY_DATA = 'geo_station_data_v1';
        const STORE_KEY_CONFIG = 'geo_station_config_v1';
        const STORE_KEY_LAST_REPORTER = 'geo_station_last_reporter';
        const STORE_KEY_MAP_VIEW = 'geo_station_map_view';
        const STORE_KEY_REPORTERS = 'geo_station_reporters_v1'; // Key lưu danh sách người nhập

        class App {
            constructor() {
                this.stations = JSON.parse(localStorage.getItem(STORE_KEY_DATA) || '[]');
                // Load config or default empty object
                this.config = JSON.parse(localStorage.getItem(STORE_KEY_CONFIG) || '{}');
                
                // Ensure default structure
                this.config = {
                    googleMapsApiKey: this.config.googleMapsApiKey || "",
                    googleSheetScriptUrl: this.config.googleSheetScriptUrl || "",
                    geminiApiKey: this.config.geminiApiKey || "",
                    customApiUrl: this.config.customApiUrl || "" 
                };
                
                this.view = 'LIST'; // LIST, FORM, SETTINGS
                this.selectedLocation = null;
                this.isSidebarOpen = window.innerWidth >= 768;
                this.listFilterQuery = ''; // State for list filter
                
                // Map References
                this.map = null;
                this.markers = [];
                this.tempMarker = null;
                this.accuracyCircle = null; // Vòng tròn hiển thị sai số
                this.routingControl = null; // Biến lưu control chỉ đường
                
                this.init();
            }

            init() {
                this.initMap();
                this.renderSidebar();
                this.updateSidebarVisibility();
                lucide.createIcons();
            }

            // --- MAP LOGIC ---
            initMap() {
                // 1. Tải vị trí cuối cùng từ LocalStorage
                const savedView = JSON.parse(localStorage.getItem(STORE_KEY_MAP_VIEW) || 'null');
                
                // Default Ho Chi Minh City (HCM) nếu không có savedView
                const startLat = savedView ? savedView.lat : 10.7769;
                const startLng = savedView ? savedView.lng : 106.7009;
                const startZoom = savedView ? savedView.zoom : 12;

                this.map = L.map('map', { 
                    zoomControl: false,
                    maxZoom: 20, 
                    minZoom: 12 // Khóa zoom nhỏ: chỉ cho phép zoom từ mức 12 trở lên
                }).setView([startLat, startLng], startZoom);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(this.map);
                L.control.zoom({ position: 'bottomright' }).addTo(this.map);

                // 2. Sự kiện lưu vị trí khi di chuyển/zoom
                const saveMapState = () => {
                    const center = this.map.getCenter();
                    localStorage.setItem(STORE_KEY_MAP_VIEW, JSON.stringify({
                        lat: center.lat,
                        lng: center.lng,
                        zoom: this.map.getZoom()
                    }));
                };
                this.map.on('moveend', saveMapState);
                this.map.on('zoomend', saveMapState);

                // Click Event
                this.map.on('click', (e) => {
                    // Nếu click thủ công, sai số là null/undefined hoặc coi như thủ công
                    this.handleMapClick({ lat: e.latlng.lat, lng: e.latlng.lng, accuracy: null });
                });

                this.renderMapMarkers();
            }

            renderMapMarkers() {
                // Clear existing
                this.markers.forEach(m => this.map.removeLayer(m));
                this.markers = [];

                // Add Stations
                this.stations.forEach(station => {
                    const marker = L.circleMarker([station.location.lat, station.location.lng], {
                        color: 'white',
                        fillColor: '#2563EB', // blue-600
                        fillOpacity: 1,
                        radius: 8,
                        weight: 2
                    }).addTo(this.map);
                    
                    marker.bindTooltip(station.name);
                    marker.on('click', (e) => {
                        L.DomEvent.stopPropagation(e);
                        this.handleMarkerClick(station);
                    });
                    this.markers.push(marker);
                });
            }

            updateTempMarker() {
                if (this.tempMarker) {
                    this.map.removeLayer(this.tempMarker);
                    this.tempMarker = null;
                }
                if (this.accuracyCircle) {
                    this.map.removeLayer(this.accuracyCircle);
                    this.accuracyCircle = null;
                }

                if (this.selectedLocation) {
                    const redIcon = L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });

                    // Vẽ vòng tròn sai số nếu có dữ liệu GPS
                    if (this.selectedLocation.accuracy && this.selectedLocation.accuracy > 0) {
                        this.accuracyCircle = L.circle([this.selectedLocation.lat, this.selectedLocation.lng], {
                            radius: this.selectedLocation.accuracy,
                            color: '#3b82f6',
                            fillColor: '#3b82f6',
                            fillOpacity: 0.1,
                            weight: 1,
                            dashArray: '5, 5'
                        }).addTo(this.map);
                    }

                    // Cho phép draggable (kéo thả)
                    this.tempMarker = L.marker([this.selectedLocation.lat, this.selectedLocation.lng], { 
                        icon: redIcon,
                        draggable: true 
                    }).addTo(this.map);

                    // Tooltip hướng dẫn
                    this.tempMarker.bindTooltip("Kéo để chỉnh vị trí", {direction: 'top', offset: [0, -40]}).openTooltip();
                    setTimeout(() => this.tempMarker.closeTooltip(), 3000);

                    // Sự kiện khi kéo xong marker
                    this.tempMarker.on('dragend', (event) => {
                        const position = event.target.getLatLng();
                        
                        // Khi kéo tay, sai số GPS cũ không còn ý nghĩa -> Xóa vòng tròn sai số
                        if (this.accuracyCircle) {
                            this.map.removeLayer(this.accuracyCircle);
                            this.accuracyCircle = null;
                        }

                        // Set accuracy = null (Thủ công)
                        this.selectedLocation = { lat: position.lat, lng: position.lng, accuracy: null };
                        
                        // Cập nhật tọa độ trên Form nếu đang mở
                        const latEl = document.getElementById('disp-lat');
                        const lngEl = document.getElementById('disp-lng');
                        const accEl = document.getElementById('disp-acc');
                        
                        if (latEl && lngEl) {
                            latEl.innerText = `Lat: ${position.lat.toFixed(5)}`;
                            lngEl.innerText = `Lng: ${position.lng.toFixed(5)}`;
                        }
                        if (accEl) {
                            accEl.innerText = `Sai số: Thủ công`;
                            accEl.className = 'text-orange-600 font-medium';
                        }
                    });
                }
            }

            locateMe() {
                if (navigator.geolocation) {
                    // UI Feedback: Đổi icon thành loading
                    const btn = document.getElementById('btn-locate');
                    const originalContent = btn.innerHTML;
                    btn.innerHTML = '<i data-lucide="loader-2" class="w-6 h-6 animate-spin"></i>';
                    lucide.createIcons();

                    const options = {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0 // Bắt buộc lấy mới, không dùng cache
                    };

                    let watchId = null;
                    let bestPosition = null;

                    // Hàm hoàn tất
                    const finish = (pos) => {
                        if (watchId !== null) {
                            navigator.geolocation.clearWatch(watchId);
                            watchId = null;
                        }
                        btn.innerHTML = originalContent;
                        lucide.createIcons();

                        if (pos) {
                            const loc = { 
                                lat: pos.coords.latitude, 
                                lng: pos.coords.longitude,
                                accuracy: pos.coords.accuracy 
                            };
                            this.handleMapClick(loc);
                            // Zoom vừa đủ để thấy cả sai số nếu sai số lớn, hoặc zoom 18 nếu sai số nhỏ
                            if (loc.accuracy > 100) {
                                this.map.flyTo([loc.lat, loc.lng], 16);
                            } else {
                                this.map.flyTo([loc.lat, loc.lng], 18);
                            }
                        } else {
                            alert("Không thể lấy vị trí chính xác. Vui lòng kiểm tra GPS.");
                        }
                    };

                    // Sử dụng watchPosition để "warm-up" GPS
                    watchId = navigator.geolocation.watchPosition(
                        (pos) => {
                            // Lưu vị trí tốt nhất tìm được
                            if (!bestPosition || pos.coords.accuracy < bestPosition.coords.accuracy) {
                                bestPosition = pos;
                            }

                            // Nếu sai số < 20m, chấp nhận ngay
                            if (pos.coords.accuracy <= 20) {
                                finish(pos);
                            }
                        },
                        (err) => {
                            console.warn("GPS Error:", err);
                            // Nếu lỗi, vẫn thử chờ timeout xem có dữ liệu cũ không, hoặc kết thúc
                        },
                        options
                    );

                    // Timeout sau 5 giây: Lấy kết quả tốt nhất hiện có
                    setTimeout(() => {
                        if (watchId !== null) {
                            finish(bestPosition);
                        }
                    }, 5000);

                } else {
                    alert("Trình duyệt không hỗ trợ định vị.");
                }
            }

            // --- SEARCH FUNCTION ---
            toggleSearch() {
                const el = document.getElementById('search-container');
                if (el) {
                    el.classList.toggle('hidden');
                    if (!el.classList.contains('hidden')) {
                        const inp = document.getElementById('search-input');
                        if(inp) inp.focus();
                    }
                }
            }

            async searchAddress(query) {
                if (!query) return;
                const inp = document.getElementById('search-input');
                const originalPlaceholder = inp.placeholder;
                
                // Visual feedback
                inp.disabled = true;
                inp.classList.add('bg-gray-100');
                
                try {
                    // Nominatim OpenStreetMap Search API
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        const result = data[0];
                        const lat = parseFloat(result.lat);
                        const lng = parseFloat(result.lon);
                        
                        // Fly to location
                        this.map.setView([lat, lng], 16);
                        
                        // Show result name in popup
                        L.popup()
                            .setLatLng([lat, lng])
                            .setContent(`<div class="font-medium text-sm text-center">${result.display_name}</div>`)
                            .openOn(this.map);
                            
                    } else {
                        alert("Không tìm thấy địa chỉ này.");
                    }
                } catch (error) {
                    console.error("Search error:", error);
                    alert("Lỗi kết nối khi tìm kiếm.");
                } finally {
                    inp.disabled = false;
                    inp.classList.remove('bg-gray-100');
                    inp.focus();
                }
            }

            // --- ROUTING FUNCTION (CHỈ ĐƯỜNG) ---
            routeTo(destLat, destLng) {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        const myLat = pos.coords.latitude;
                        const myLng = pos.coords.longitude;

                        // Xóa route cũ nếu có
                        this.clearRoute();

                        // Tạo route mới
                        this.routingControl = L.Routing.control({
                            waypoints: [
                                L.latLng(myLat, myLng),
                                L.latLng(destLat, destLng)
                            ],
                            routeWhileDragging: false,
                            language: 'vi', // Tiếng Việt
                            showAlternatives: false,
                            fitSelectedRoutes: true,
                            lineOptions: {
                                styles: [{color: '#6366f1', opacity: 0.8, weight: 6}]
                            },
                            // Tắt bớt các marker mặc định của LRM để đỡ rối
                            createMarker: function(i, wp, nWps) {
                                return null; 
                            }
                        }).addTo(this.map);

                        document.getElementById('btn-clear-route').classList.remove('hidden');
                        
                        // Đóng sidebar trên mobile để xem bản đồ
                        if (window.innerWidth < 768) {
                            this.isSidebarOpen = false;
                            this.updateSidebarVisibility();
                        }

                    }, () => alert("Cần quyền truy cập vị trí để chỉ đường."));
                } else {
                    alert("Trình duyệt không hỗ trợ định vị.");
                }
            }

            clearRoute() {
                if (this.routingControl) {
                    this.map.removeControl(this.routingControl);
                    this.routingControl = null;
                }
                document.getElementById('btn-clear-route').classList.add('hidden');
            }

            // --- ACTIONS ---
            handleMapClick(loc) {
                this.selectedLocation = loc;
                this.updateTempMarker();
                this.setSidebarView('FORM');
                if (!this.isSidebarOpen) this.toggleSidebar();
            }

            handleMarkerClick(station) {
                this.map.setView([station.location.lat, station.location.lng], 16); 
                this.setSidebarView('LIST');
                if (!this.isSidebarOpen) this.toggleSidebar();
            }

            async saveStation(data) {
                this.stations.unshift(data);
                this.saveData();
                this.selectedLocation = null;
                this.updateTempMarker();
                this.renderMapMarkers();
                this.setSidebarView('LIST');
                
                if (this.config.googleSheetScriptUrl) {
                    this.syncToSheet(data);
                }
                if (this.config.customApiUrl) {
                    await this.syncToApi(data);
                }
            }

            deleteStation(id) {
                if(confirm('Bạn có chắc muốn xóa trạm này?')) {
                    this.stations = this.stations.filter(s => s.id !== id);
                    this.saveData();
                    this.renderMapMarkers();
                    this.renderSidebar();
                }
            }

            saveData() {
                localStorage.setItem(STORE_KEY_DATA, JSON.stringify(this.stations));
            }

            saveConfig(newConfig) {
                this.config = newConfig;
                localStorage.setItem(STORE_KEY_CONFIG, JSON.stringify(this.config));
                this.setSidebarView('LIST');
                alert("Đã lưu cài đặt!");
            }

            // --- UI RENDERING ---
            toggleSidebar() {
                this.isSidebarOpen = !this.isSidebarOpen;
                this.updateSidebarVisibility();
            }

            updateSidebarVisibility() {
                const el = document.getElementById('sidebar');
                const btn = document.getElementById('mobile-menu-btn');
                if (this.isSidebarOpen) {
                    el.classList.remove('-translate-x-full');
                    if(btn) btn.classList.add('hidden');
                } else {
                    el.classList.add('-translate-x-full');
                    if(btn) btn.classList.remove('hidden');
                }
            }

            setSidebarView(viewName) {
                this.view = viewName;
                if (viewName === 'LIST') {
                    this.selectedLocation = null;
                    this.listFilterQuery = ''; // Reset filter when opening list view
                }
                this.updateTempMarker();
                this.renderSidebar();
            }

            renderSidebar() {
                const container = document.getElementById('sidebar-content');
                container.innerHTML = '';

                if (this.view === 'LIST') {
                    container.innerHTML = this.getListViewHTML();
                } else if (this.view === 'FORM') {
                    this.renderFormView(container);
                } else if (this.view === 'SETTINGS') {
                    this.renderSettingsView(container);
                }
                
                lucide.createIcons();
            }

            // Helper to generate station items HTML
            getStationItemsHTML() {
                const query = (this.listFilterQuery || '').toLowerCase().trim();
                const filteredStations = this.stations.filter(s => {
                    const name = (s.name || '').toLowerCase();
                    const reporter = (s.reporter || '').toLowerCase();
                    const code = (s.code || '').toLowerCase();
                    return name.includes(query) || reporter.includes(query) || code.includes(query);
                });

                if (filteredStations.length === 0) {
                     if (this.stations.length === 0) {
                        return `<div class="text-center text-gray-400 mt-10 p-4">
                            <i data-lucide="map-pin" class="w-10 h-10 mx-auto opacity-50 mb-2"></i>
                            <p>Chưa có dữ liệu.</p>
                            <p class="text-sm">Bấm định vị hoặc vào bản đồ để thêm trạm mới.</p>
                        </div>`;
                     }
                     return `<div class="text-center text-gray-400 mt-10 p-4">
                        <i data-lucide="search-x" class="w-10 h-10 mx-auto opacity-50 mb-2"></i>
                        <p>Không tìm thấy kết quả phù hợp.</p>
                       </div>`;
                }

                return filteredStations.map(s => `
                        <div class="border rounded-lg p-3 hover:shadow-md transition bg-white mb-3 group relative cursor-pointer" onclick="app.handleMarkerClick(${JSON.stringify(s).replace(/"/g, '&quot;')})">
                             <div class="flex justify-between items-start">
                                <div>
                                  <h3 class="font-semibold text-gray-900">${s.name}</h3>
                                  ${s.code ? `<p class="text-xs text-indigo-600 font-mono mb-0.5">Mã: ${s.code}</p>` : ''}
                                  <p class="text-xs text-gray-500 mb-1">${s.address}</p>
                                  <p class="text-xs text-blue-600 font-medium mb-2"><span class="text-gray-400 font-normal">Người nhập:</span> ${s.reporter || 'N/A'}</p>
                                </div>
                                <div class="flex flex-col gap-1">
                                    <button onclick="event.stopPropagation(); app.deleteStation('${s.id}')" class="text-red-400 hover:text-red-600 p-1" title="Xóa">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                             </div>
                             ${s.images.length ? `<div class="flex gap-2 mb-2 overflow-x-auto pb-2 scrollbar-hide">
                                ${s.images.map(img => `<img src="${img}" class="w-16 h-16 object-cover rounded flex-shrink-0" />`).join('')}
                             </div>` : ''}
                             <p class="text-sm text-gray-600 line-clamp-2 bg-gray-50 p-2 rounded">${s.description || 'Không có mô tả'}</p>
                             ${s.location.accuracy ? `<p class="text-[10px] text-gray-400 mt-1 text-right">Sai số GPS: ±${Math.round(s.location.accuracy)}m</p>` : ''}
                             
                             <!-- Nút chỉ đường -->
                             <button onclick="event.stopPropagation(); app.routeTo(${s.location.lat}, ${s.location.lng})" class="mt-2 w-full flex items-center justify-center gap-2 bg-green-50 text-green-700 py-1.5 rounded hover:bg-green-100 text-xs font-medium border border-green-200">
                                <i data-lucide="navigation" class="w-3 h-3"></i> Chỉ đường đến đây
                             </button>
                        </div>
                    `).join('');
            }

            setListFilter(query) {
                this.listFilterQuery = query;
                const container = document.getElementById('station-list-items');
                if (container) {
                    container.innerHTML = this.getStationItemsHTML();
                    lucide.createIcons();
                }
            }

            // HTML Generator: LIST
            getListViewHTML() {
                return `
                    <div class="p-4 border-b bg-gray-50 space-y-3 sticky top-0 z-10">
                        <div class="flex justify-between items-center">
                            <h1 class="font-bold text-lg text-gray-800">Danh sách trạm (${this.stations.length})</h1>
                            <div class="flex gap-2">
                                <button onclick="app.exportCSV()" class="text-blue-600 hover:bg-blue-50 p-2 rounded" title="Xuất Excel/CSV">
                                    <i data-lucide="download" class="w-5 h-5"></i>
                                </button>
                                <!-- Nút Đóng -->
                                <button onclick="app.toggleSidebar()" class="text-gray-500 hover:bg-red-50 hover:text-red-600 p-2 rounded" title="Đóng">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Bộ lọc danh sách -->
                        <div class="relative">
                            <input type="text" 
                                value="${this.listFilterQuery || ''}"
                                oninput="app.setListFilter(this.value)"
                                placeholder="Tìm theo tên, mã trạm..." 
                                class="w-full pl-9 pr-3 py-2 rounded border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-white">
                            <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-2.5"></i>
                        </div>
                    </div>
                    <div id="station-list-items" class="flex-1 overflow-y-auto p-4 bg-gray-100">
                        ${this.getStationItemsHTML()}
                    </div>
                `;
            }

            // HTML Generator: FORM
            renderFormView(container) {
                // 1. Chuẩn bị dữ liệu danh sách người nhập
                const lastReporter = localStorage.getItem(STORE_KEY_LAST_REPORTER) || '';
                let reporters = JSON.parse(localStorage.getItem(STORE_KEY_REPORTERS) || '[]');
                
                // Đảm bảo tên người nhập cuối cùng (nếu có) luôn nằm trong danh sách
                if (lastReporter && !reporters.includes(lastReporter)) {
                    reporters.push(lastReporter);
                    localStorage.setItem(STORE_KEY_REPORTERS, JSON.stringify(reporters));
                }
                
                // Sắp xếp danh sách
                reporters.sort();

                const optionsHtml = reporters.map(r => 
                    `<option value="${r}" ${r === lastReporter ? 'selected' : ''}>${r}</option>`
                ).join('');

                // Format accuracy
                const accuracy = this.selectedLocation.accuracy;
                let accText = 'Thủ công';
                let accClass = 'text-orange-600 font-medium';
                if (accuracy !== null && accuracy !== undefined) {
                    accText = `±${Math.round(accuracy)} mét`;
                    accClass = 'text-green-600 font-bold';
                }

                // Template
                container.innerHTML = `
                    <div class="p-4 border-b flex justify-between items-center bg-blue-600 text-white">
                        <h2 class="font-semibold text-lg flex items-center gap-2">
                            <i data-lucide="map-pin" class="w-5 h-5"></i> Thêm Trạm Mới
                        </h2>
                        <button onclick="app.setSidebarView('LIST')" class="hover:bg-blue-700 p-1 rounded">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <form id="station-form" class="p-5 space-y-4 flex-1 overflow-y-auto">
                        <div class="bg-gray-50 p-2 rounded text-xs text-gray-600 grid grid-cols-2 gap-2">
                            <span id="disp-lat">Lat: ${this.selectedLocation.lat.toFixed(5)}</span>
                            <span id="disp-lng">Lng: ${this.selectedLocation.lng.toFixed(5)}</span>
                            <span class="col-span-2 border-t pt-1 mt-1">Sai số: <span id="disp-acc" class="${accClass}">${accText}</span></span>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Họ tên người nhập <span class="text-red-500">*</span></label>
                            <div class="flex flex-col gap-2">
                                <select id="sel-reporter" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                    <option value="">-- Chọn người nhập --</option>
                                    ${optionsHtml}
                                    <option value="__NEW__" class="text-blue-600 font-semibold">+ Nhập tên mới...</option>
                                </select>
                                <input type="text" id="inp-reporter-new" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none hidden" placeholder="Nhập tên người mới...">
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-3">
                             <div class="col-span-1">
                                <label class="block text-sm font-medium mb-1">Mã trạm</label>
                                <input type="text" id="inp-code" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none uppercase font-mono" placeholder="T01">
                             </div>
                             <div class="col-span-2">
                                <label class="block text-sm font-medium mb-1">Tên trạm <span class="text-red-500">*</span></label>
                                <input type="text" id="inp-name" required class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ví dụ: Trạm Biến áp A">
                             </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-1">Địa chỉ <span class="text-red-500">*</span></label>
                            <input type="text" id="inp-address" required class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Số 1, Đại Cồ Việt...">
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-1">Hình ảnh (Max 4)</label>
                            <div id="img-preview" class="grid grid-cols-4 gap-2 mb-2"></div>
                            <button type="button" onclick="document.getElementById('inp-file').click()" class="border-2 border-dashed w-full p-2 text-gray-400 rounded hover:border-blue-500 text-sm flex items-center justify-center gap-2">
                                <i data-lucide="camera" class="w-4 h-4"></i> Thêm ảnh
                            </button>
                            <input type="file" id="inp-file" accept="image/*" multiple class="hidden">
                        </div>

                        <div>
                            <div class="flex justify-between items-end mb-1">
                                <label class="block text-sm font-medium">Mô tả / Ghi chú <span class="text-red-500">*</span></label>
                                <button type="button" id="btn-ai" class="text-xs bg-purple-50 text-purple-700 px-2 py-1 rounded border border-purple-200 flex items-center gap-1">
                                    <i data-lucide="sparkles" class="w-3 h-3"></i> Tự động điền (AI)
                                </button>
                            </div>
                            <textarea id="inp-desc" required rows="4" class="w-full border rounded p-2 text-sm" placeholder="Mô tả chi tiết..."></textarea>
                        </div>

                        <div class="flex gap-3 mt-4">
                            <button type="button" id="btn-cancel" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded font-medium hover:bg-gray-300 flex justify-center gap-2">
                                <i data-lucide="x" class="w-5 h-5"></i> Hủy
                            </button>
                            <button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded font-medium hover:bg-blue-700 flex justify-center gap-2">
                                <i data-lucide="save" class="w-5 h-5"></i> Lưu thông tin
                            </button>
                        </div>
                    </form>
                `;

                // Logic for Form
                const selReporter = document.getElementById('sel-reporter');
                const inpReporterNew = document.getElementById('inp-reporter-new');
                
                // Xử lý nút Hủy
                document.getElementById('btn-cancel').onclick = () => {
                    this.selectedLocation = null;
                    this.updateTempMarker();
                    this.setSidebarView('LIST');
                    if (window.innerWidth < 768) {
                        this.isSidebarOpen = false;
                        this.updateSidebarVisibility();
                    }
                };

                // Xử lý khi đổi lựa chọn
                selReporter.onchange = (e) => {
                    if (e.target.value === '__NEW__') {
                        inpReporterNew.classList.remove('hidden');
                        inpReporterNew.focus();
                    } else {
                        inpReporterNew.classList.add('hidden');
                        // Lưu ngay vào "cookies" (localStorage) nếu chọn tên có sẵn
                        if (e.target.value) {
                            localStorage.setItem(STORE_KEY_LAST_REPORTER, e.target.value);
                        }
                    }
                };

                const images = [];
                const renderImages = () => {
                    const div = document.getElementById('img-preview');
                    div.innerHTML = images.map((img, i) => `
                        <div class="relative aspect-square rounded overflow-hidden border">
                            <img src="${img}" class="w-full h-full object-cover">
                            <button type="button" onclick="document.getElementById('station-form').removeImage(${i})" class="absolute top-0 right-0 bg-red-500 text-white p-0.5">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </div>
                    `).join('');
                    lucide.createIcons();
                };

                document.getElementById('station-form').removeImage = (idx) => {
                    images.splice(idx, 1);
                    renderImages();
                };

                document.getElementById('inp-file').onchange = (e) => {
                    const files = Array.from(e.target.files).slice(0, 4 - images.length);
                    files.forEach(file => {
                        const reader = new FileReader();
                        reader.onload = () => { images.push(reader.result); renderImages(); };
                        reader.readAsDataURL(file);
                    });
                };

                // AI Button
                document.getElementById('btn-ai').onclick = async (e) => {
                    if(!images.length) return alert("Vui lòng tải ảnh lên trước.");
                    const btn = e.currentTarget;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = `<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Đang phân tích...`;
                    lucide.createIcons();
                    
                    try {
                        const desc = await this.callGemini(images, this.selectedLocation);
                        document.getElementById('inp-desc').value = desc;
                    } catch (err) {
                        alert("Lỗi AI: " + err.message);
                    } finally {
                        btn.innerHTML = originalText;
                        lucide.createIcons();
                    }
                };

                // Submit
                document.getElementById('station-form').onsubmit = (e) => {
                    e.preventDefault();
                    
                    let reporterVal = selReporter.value;
                    
                    // Nếu chọn nhập mới, lấy giá trị từ ô input
                    if (reporterVal === '__NEW__') {
                         reporterVal = inpReporterNew.value.trim();
                    }

                    const nameVal = document.getElementById('inp-name').value.trim();
                    const codeVal = document.getElementById('inp-code').value.trim().toUpperCase();
                    const addressVal = document.getElementById('inp-address').value.trim();
                    const descVal = document.getElementById('inp-desc').value.trim();
                    
                    if (!reporterVal || !nameVal || !addressVal || !descVal) {
                        return alert("Vui lòng nhập đầy đủ các thông tin bắt buộc.");
                    }

                    // Lưu tên mới vào danh sách nếu chưa có
                    if (!reporters.includes(reporterVal)) {
                        reporters.push(reporterVal);
                        localStorage.setItem(STORE_KEY_REPORTERS, JSON.stringify(reporters));
                    }
                    
                    // Cập nhật người nhập cuối cùng
                    localStorage.setItem(STORE_KEY_LAST_REPORTER, reporterVal);

                    const data = {
                        id: crypto.randomUUID(),
                        code: codeVal,
                        reporter: reporterVal,
                        name: nameVal,
                        address: addressVal,
                        description: descVal,
                        location: this.selectedLocation,
                        images: images,
                        timestamp: Date.now()
                    };
                    this.saveStation(data);
                };
            }

            // HTML Generator: SETTINGS
            renderSettingsView(container) {
                container.innerHTML = `
                    <div class="p-6 h-full overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                             <h2 class="text-2xl font-bold">Cài đặt</h2>
                             <button onclick="app.setSidebarView('LIST')" class="text-gray-500 hover:text-gray-800"><i data-lucide="x"></i></button>
                        </div>
                        <form id="settings-form" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium mb-1">Custom API URL (AJAX)</label>
                                <input type="text" id="cfg-api" value="${this.config.customApiUrl || ''}" class="w-full border p-2 rounded" placeholder="https://api.domain.com/save-station">
                                <p class="text-xs text-gray-500 mt-1">Hệ thống sẽ POST dữ liệu dạng JSON về URL này.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Gemini API Key</label>
                                <input type="password" id="cfg-gemini" value="${this.config.geminiApiKey || ''}" class="w-full border p-2 rounded" placeholder="AIzaSy...">
                                <p class="text-xs text-gray-500 mt-1">Cần thiết để dùng tính năng AI tạo mô tả ảnh.</p>
                            </div>
                            
                             <div class="pt-4 border-t">
                                <label class="block text-sm font-medium mb-1 text-gray-500">Tùy chọn khác (Ít dùng)</label>
                                <div class="space-y-3">
                                    <input type="text" id="cfg-script" value="${this.config.googleSheetScriptUrl || ''}" class="w-full border p-2 rounded text-sm" placeholder="Google Apps Script URL (Tùy chọn)">
                                    <input type="password" id="cfg-key" value="${this.config.googleMapsApiKey || ''}" class="w-full border p-2 rounded text-sm" placeholder="Google Maps API Key (Để trống dùng OSM)">
                                </div>
                            </div>

                            <button type="submit" class="w-full bg-black text-white py-2 rounded flex justify-center gap-2">
                                <i data-lucide="save" class="w-4 h-4"></i> Lưu Cài đặt
                            </button>
                        </form>
                    </div>
                `;
                
                document.getElementById('settings-form').onsubmit = (e) => {
                    e.preventDefault();
                    this.saveConfig({
                        customApiUrl: document.getElementById('cfg-api').value,
                        geminiApiKey: document.getElementById('cfg-gemini').value,
                        googleSheetScriptUrl: document.getElementById('cfg-script').value,
                        googleMapsApiKey: document.getElementById('cfg-key').value
                    });
                };
            }

            // --- SERVICES ---
            async syncToApi(station) {
                const url = this.config.customApiUrl;
                if (!url) return;
                console.log("Đang gửi dữ liệu về API...", station);
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(station)
                    });
                    if (!response.ok) throw new Error(`API trả về lỗi: ${response.status}`);
                    console.log("Đã lưu thành công vào API riêng!");
                } catch (error) {
                    console.error("Lỗi khi gọi API:", error);
                    alert("Không thể lưu vào API: " + error.message);
                }
            }

            async callGemini(base64Images, location) {
                if (!this.config.geminiApiKey) throw new Error("Chưa nhập Gemini API Key trong Cài đặt.");
                const ai = new GoogleGenAI({ apiKey: this.config.geminiApiKey });
                const parts = base64Images.map(img => ({
                    inlineData: { mimeType: "image/jpeg", data: img.split("base64,")[1] || img }
                }));
                parts.push({ 
                    text: `Hãy phân tích hình ảnh trạm/cơ sở hạ tầng tại tọa độ (${location.lat}, ${location.lng}). Mã trạm nếu có. Mô tả ngắn gọn (dưới 100 từ) về tình trạng, thiết bị nhìn thấy và môi trường xung quanh.` 
                });
                const response = await ai.models.generateContent({
                    model: "gemini-2.5-flash-latest",
                    contents: { parts: parts }
                });
                return response.text();
            }

            async syncToSheet(station) {
                const url = this.config.googleSheetScriptUrl;
                try {
                    const payload = new FormData();
                    payload.append('id', station.id);
                    payload.append('code', station.code || '');
                    payload.append('reporter', station.reporter || '');
                    payload.append('name', station.name);
                    payload.append('address', station.address);
                    payload.append('lat', station.location.lat);
                    payload.append('lng', station.location.lng);
                    payload.append('accuracy', station.location.accuracy || '');
                    payload.append('description', station.description);
                    await fetch(url, { method: 'POST', mode: 'no-cors', body: payload });
                    console.log("Sent to sheet");
                } catch (e) {
                    console.error("Sheet sync failed", e);
                }
            }

            exportCSV() {
                const headers = ['ID,Code,Reporter,Name,Address,Lat,Lng,Accuracy(m),Description,Timestamp'];
                const rows = this.stations.map(s => [
                    s.id,
                    `"${(s.code || '').replace(/"/g, '""')}"`,
                    `"${(s.reporter || '').replace(/"/g, '""')}"`,
                    `"${s.name.replace(/"/g, '""')}"`,
                    `"${s.address.replace(/"/g, '""')}"`,
                    s.location.lat,
                    s.location.lng,
                    s.location.accuracy || '',
                    `"${s.description.replace(/"/g, '""')}"`,
                    new Date(s.timestamp).toISOString()
                ].join(','));
                
                const blob = new Blob([headers.concat(rows).join('\n')], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `stations_${Date.now()}.csv`;
                link.click();
            }
        }

        // Initialize Global App Instance
        window.app = new App();
    </script>
</body>
</html>